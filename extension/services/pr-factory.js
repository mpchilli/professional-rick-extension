#!/usr/bin/env node
import * as fs from 'fs';
import * as path from 'path';
import { run_cmd, Style } from './core-utils.js';
export function createPR(sessionDir) {
    const statePath = path.join(sessionDir, 'state.json');
    if (!fs.existsSync(statePath)) {
        throw new Error('state.json not found');
    }
    const state = JSON.parse(fs.readFileSync(statePath, 'utf-8'));
    const repoPath = state.working_dir;
    // Use git_utils or raw git
    const branch = run_cmd(['git', 'rev-parse', '--abbrev-ref', 'HEAD'], { cwd: repoPath }).trim();
    const title = `Architect Loop: ${state.original_prompt.slice(0, 50)}...`;
    const body = `Generated by Architect Loop.
    
Session: ${path.basename(sessionDir)}
Prompt: ${state.original_prompt}`;
    try {
        const output = run_cmd(['gh', 'pr', 'create', '--title', title, '--body', body], {
            cwd: repoPath,
        });
        return output.trim();
    }
    catch (err) {
        throw new Error(`Failed to create PR: ${err.message}`);
    }
}
// CLI
if (process.argv[1] && path.basename(process.argv[1]).startsWith('pr-factory')) {
    const sessionDir = process.argv[2];
    if (!sessionDir) {
        console.error('Usage: node pr_factory.js <session_dir>');
        process.exit(1);
    }
    try {
        const url = createPR(sessionDir);
        console.log(`${Style.GREEN}PR Created: ${url}${Style.RESET}`);
    }
    catch (err) {
        console.error(`${Style.RED}Error: ${err.message}${Style.RESET}`);
        process.exit(1);
    }
}
